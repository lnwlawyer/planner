<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OmniPlan Productivity App</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2666/2666505.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Libraries for Exporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Import Maps for Modules -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        /* Prevent pull-to-refresh and selection on mobile for app-like feel */
        body { 
            overscroll-behavior-y: none; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        input, textarea { user-select: text; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => console.log('ServiceWorker registered'))
                    .catch(err => console.log('ServiceWorker failed: ', err));
            });
        }
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Calendar as CalendarIcon, CheckCircle, Circle, Plus, Trash2, 
            ChevronLeft, ChevronRight, Zap, Award, User, Target, 
            PenTool, Clock, Grid, Layout, X, Play, Pause, RotateCcw,
            Volume2, VolumeX, Save, Moon, Sun, Sword, Heart, Shield,
            MoreHorizontal, AlertCircle, LayoutList, Book, Palette, Type, LogOut, LogIn,
            ZoomIn, ZoomOut, Maximize, Image as ImageIcon, FileDown, Download,
            RefreshCw, Link as LinkIcon, Cloud, Globe, ExternalLink, Folder
        } from 'lucide-react';

        import { initializeApp } from "firebase/app";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot } from "firebase/firestore";

        const firebaseConfig = {
            apiKey: "AIzaSyChLR9pMmY1QCgD2HjJ0GjTGS5mx6tG0N8",
            authDomain: "lnwlawyer.firebaseapp.com",
            projectId: "lnwlawyer",
            storageBucket: "lnwlawyer.firebasestorage.app",
            messagingSenderId: "105328800542",
            appId: "1:105328800542:web:69fbb578626c41e6548f0f",
            measurementId: "G-ZK14PNC90Q"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- HELPER: HSL to Hex ---
        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }

        // --- COMPONENT: Color Wheel Modal ---
        const ColorPickerModal = ({ isOpen, onClose, onSelect, title }) => {
            if (!isOpen) return null;

            const handleWheelClick = (e) => {
                const rect = e.target.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;
                
                // Calculate Hue (Angle)
                let angle = Math.atan2(y, x) * (180 / Math.PI);
                angle = (angle + 360 + 90) % 360; // Adjust to start from top/red

                // Calculate Saturation (Distance from center)
                const radius = rect.width / 2;
                const dist = Math.sqrt(x * x + y * y);
                let sat = Math.min(100, (dist / radius) * 100);

                // Use fixed Lightness for vibrant colors
                const color = hslToHex(angle, sat, 60); 
                onSelect(color);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-2xl flex flex-col items-center gap-6 max-w-sm w-full mx-4">
                        <div className="flex justify-between w-full items-center">
                            <h3 className="text-lg font-bold text-gray-700 dark:text-gray-200">{title}</h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                <X size={20} className="text-gray-500"/>
                            </button>
                        </div>
                        
                        {/* The Color Wheel */}
                        <div 
                            className="w-64 h-64 rounded-full shadow-inner cursor-pointer relative overflow-hidden ring-4 ring-white dark:ring-gray-700 active:scale-95 transition-transform"
                            style={{ 
                                background: 'conic-gradient(from 0deg, red, yellow, lime, aqua, blue, magenta, red)',
                            }}
                            onClick={handleWheelClick}
                        >
                            <div className="absolute inset-0 rounded-full" style={{ background: 'radial-gradient(circle, white 0%, transparent 70%)' }}></div>
                        </div>

                        <p className="text-sm text-gray-400">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ</p>
                    </div>
                </div>
            );
        };

        const OmniPlan = () => {
            const HOURS = Array.from({length: 16}, (_, i) => `${(i + 6).toString().padStart(2, '0')}:00`); 
            
            const FONT_SIZES = [
                { id: 'text-sm', label: 'A', scale: '0.8' },
                { id: 'text-base', label: 'A', scale: '1.0' },
                { id: 'text-lg', label: 'A', scale: '1.2' },
                { id: 'text-xl', label: 'A', scale: '1.5' },
                { id: 'text-2xl', label: 'A', scale: '1.8' },
            ];

            const PEN_SIZES = [
                { id: 2, label: 'XS' },
                { id: 4, label: 'S' },
                { id: 6, label: 'M' },
                { id: 10, label: 'L' },
                { id: 16, label: 'XL' },
            ];

            // --- AUTHENTICATION STATE ---
            const [user, setUser] = useState(null);
            const [gCalToken, setGCalToken] = useState(null); // Google API Access Token

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                setUser(currentUser);
                });
                return () => unsubscribe();
            }, []);

            const handleLogin = async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    // Add scope for Google Calendar
                    provider.addScope('https://www.googleapis.com/auth/calendar');
                    
                    const result = await signInWithPopup(auth, provider);
                    // Get the Google Access Token
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    const token = credential.accessToken;
                    setGCalToken(token); // Store token in state for API calls
                    
                } catch (error) {
                    console.error("Login failed:", error);
                    alert(`‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:\n1. ‡πÄ‡∏û‡∏¥‡πà‡∏° Domain ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Firebase Console > Authentication > Settings > Authorized domains\n2. ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Google Sign-in method`);
                }
            };

            const handleLogout = () => {
                signOut(auth);
                setGCalToken(null);
            };

            // --- CUSTOM HOOK ---
            const useUserData = (key, initialValue) => {
                const [data, setData] = useState(() => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch { return initialValue; }
                });

                useEffect(() => {
                let unsubscribe = () => {};

                if (user) {
                    const docRef = doc(db, "users", user.uid, "app_data", key);
                    unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setData(docSnap.data().value);
                    } else {
                        setDoc(docRef, { value: data }, { merge: true });
                    }
                    });
                } else {
                    try {
                    const item = localStorage.getItem(key);
                    if (item) setData(JSON.parse(item));
                    } catch {}
                }

                return () => unsubscribe();
                }, [user, key]);

                const setSyncedData = (newData) => {
                setData(newData);
                if (user) {
                    const docRef = doc(db, "users", user.uid, "app_data", key);
                    setDoc(docRef, { value: newData }, { merge: true });
                } else {
                    localStorage.setItem(key, JSON.stringify(newData));
                }
                };

                return [data, setSyncedData];
            };

            // --- UTILS ---
            const formatDateKey = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const getTaskColor = (task) => {
                if (task.completed) return 'bg-emerald-500';
                if (task.category === 'google') return 'bg-sky-500'; // Google Event Color
                switch (task.category) {
                case 'q1': return 'bg-rose-500'; 
                case 'q2': return 'bg-blue-500'; 
                case 'q3': return 'bg-amber-500'; 
                case 'q4': return 'bg-gray-400'; 
                default: return 'bg-indigo-400'; 
                }
            };

            // --- STATE MANAGEMENT ---
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [view, setView] = useState('calendar'); 
            const [isDarkMode, setIsDarkMode] = useUserData('omni_theme', false);
            const [activeTab, setActiveTab] = useState('tasks'); 
            const [zoom, setZoom] = useState(1.0); 
            const [isSyncing, setIsSyncing] = useState(false);

            // Data
            const [tasks, setTasks] = useUserData('omni_tasks', {});
            const [timeBlocks, setTimeBlocks] = useUserData('omni_timeblocks', {}); 
            const [drawings, setDrawings] = useUserData('omni_drawings', {}); 
            const [notes, setNotes] = useUserData('omni_notes', {}); 
            const [portalApps, setPortalApps] = useUserData('omni_portal_apps', []); // New: Portal Data
            const PORTAL_CATEGORIES = ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠', '‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
            const [activePortalTab, setActivePortalTab] = useState('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
            
            // Notebook State
            const [notebookMode, setNotebookMode] = useState('text'); 
            const [notebookPage, setNotebookPage] = useState(1); 
            const exportRef = useRef(null); // Reference for exporting
            
            // Notebook Customization
            const [notebookPalette, setNotebookPalette] = useUserData('omni_notebook_palette', ['#ffffff', '#fef3c7', '#f0f9ff', '#f0fdf4', '#fdf2f8', '#1e293b']);
            const [activePaletteIndex, setActivePaletteIndex] = useState(0);
            const [notebookColor, setNotebookColor] = useUserData('omni_notebook_color', '#ffffff');

            const [notebookFontSize, setNotebookFontSize] = useUserData('omni_notebook_font_size', 'text-lg');
            const [notebookFontColor, setNotebookFontColor] = useUserData('omni_notebook_font_color', '#334155');
            const [notebookFontPalette, setNotebookFontPalette] = useUserData('omni_notebook_font_palette', ['#334155', '#000000', '#dc2626', '#16a34a', '#2563eb', '#d97706']);
            const [activeFontPaletteIndex, setActiveFontPaletteIndex] = useState(0);

            const [penSize, setPenSize] = useState(4); 
            const [penColor, setPenColor] = useUserData('omni_pen_color', '#334155');
            const [penPalette, setPenPalette] = useUserData('omni_pen_palette', ['#334155', '#000000', '#ef4444', '#22c55e', '#3b82f6', '#f59e0b']);
            const [activePenPaletteIndex, setActivePenPaletteIndex] = useState(0);
            
            // Color Picker Modal State
            const [pickerOpen, setPickerOpen] = useState(false);
            const [pickerType, setPickerType] = useState(null); // 'bg', 'font', 'pen'

            // Portal Modal State
            const [isPortalModalOpen, setIsPortalModalOpen] = useState(false);
            const [newApp, setNewApp] = useState({ name: '', url: '', icon: 'üîó', category: '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' });

            // RPG System
            const [player, setPlayer] = useUserData('omni_player', {
                name: '‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏´‡∏±‡∏î‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô',
                level: 1,
                xp: 0,
                maxXp: 100,
                hp: 50,
                maxHp: 50,
                streak: 0,
                achievements: []
            });

            // Focus Mode
            const [isZenMode, setIsZenMode] = useState(false);
            const [timer, setTimer] = useState(1500);
            const [isTimerRunning, setIsTimerRunning] = useState(false);
            const timerRef = useRef(null);
            const [touchDist, setTouchDist] = useState(null); 

            // --- HANDLERS ---
            const selectedDateKey = formatDateKey(selectedDate);
            const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            const currentNoteKey = `${selectedDateKey}_p${notebookPage}`;

            useEffect(() => { setNotebookPage(1); }, [selectedDateKey]);

            // --- PORTAL HANDLERS ---
            const handleAddApp = () => {
                if (!newApp.name || !newApp.url) return;
                let formattedUrl = newApp.url;
                if (!formattedUrl.startsWith('http://') && !formattedUrl.startsWith('https://')) {
                    formattedUrl = 'https://' + formattedUrl;
                }
                
                setPortalApps([...portalApps, { ...newApp, id: Date.now(), url: formattedUrl }]);
                setNewApp({ name: '', url: '', icon: 'üîó', category: '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' });
                setIsPortalModalOpen(false);
            };

            const handleDeleteApp = (id, e) => {
                e.stopPropagation();
                if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏≠‡∏û‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    setPortalApps(portalApps.filter(app => app.id !== id));
                }
            };

            const getUniqueCategories = () => {
                const categories = new Set(portalApps.map(app => app.category));
                return Array.from(categories).sort();
            };

            // --- GOOGLE CALENDAR LOGIC ---

            // Sync Events FROM Google TO OmniPlan
            const syncFromGoogle = async () => {
                if (!gCalToken) {
                    handleLogin();
                    return;
                }

                setIsSyncing(true);
                try {
                    // Fetch events for current month view (start of month to end of month)
                    const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                    
                    const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${startOfMonth.toISOString()}&timeMax=${endOfMonth.toISOString()}&singleEvents=true&orderBy=startTime`, {
                        headers: { Authorization: `Bearer ${gCalToken}` }
                    });

                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        throw new Error(errData.error?.message || `Server returned ${response.status}`);
                    }

                    const data = await response.json();
                    const googleEvents = data.items || [];

                    // Process and Merge Data
                    const newTasks = { ...tasks };

                    googleEvents.forEach(evt => {
                        const evtDate = evt.start.dateTime ? new Date(evt.start.dateTime) : new Date(evt.start.date);
                        const dateKey = formatDateKey(evtDate);
                        const timeStr = evt.start.dateTime ? evtDate.toTimeString().slice(0,5) : null;
                        
                        if (!newTasks[dateKey]) newTasks[dateKey] = [];

                        // Check if event already exists to prevent duplicates (using googleEventId)
                        const exists = newTasks[dateKey].some(t => t.googleEventId === evt.id);
                        
                        if (!exists) {
                            newTasks[dateKey].push({
                                id: Date.now() + Math.random(), // Local ID
                                text: evt.summary || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)',
                                completed: false,
                                category: 'google',
                                time: timeStr,
                                googleEventId: evt.id // Important for tracking
                            });
                        }
                    });

                    setTasks(newTasks); // This triggers useUserData causing save to Firestore
                    alert(`‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏î‡∏∂‡∏á‡∏°‡∏≤ ${googleEvents.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);

                } catch (error) {
                    console.error("Sync Error:", error);
                    
                    // Fallback Mode: If the specific Firebase project has restrictions on Calendar API
                    // we simulate a success for demonstration purposes so the user isn't stuck.
                    if (error.message.includes("not enabled") || error.message.includes("403") || error.message.includes("404")) {
                        const confirmDemo = confirm(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Google Calendar API ‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á Project ID)\n\nError: ${error.message}\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Demo Data) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
                        
                        if (confirmDemo) {
                            const newTasks = { ...tasks };
                            const demoKey = formatDateKey(selectedDate);
                            if (!newTasks[demoKey]) newTasks[demoKey] = [];
                            
                            newTasks[demoKey].push({
                                id: Date.now(),
                                text: "‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏ó‡∏µ‡∏° (Google Demo)",
                                completed: false,
                                category: 'google',
                                time: "10:00",
                                googleEventId: "demo_id_1"
                            });
                            
                            setTasks(newTasks);
                            alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                        }
                    } else {
                        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå: ${error.message}`);
                    }
                } finally {
                    setIsSyncing(false);
                }
            };

            // Add Event TO Google
            const addToGoogle = async (taskText, taskTime, taskDate) => {
                if (!gCalToken) return null;

                try {
                    let startDateTime, endDateTime;
                    
                    if (taskTime) {
                        // Creating ISO DateTime string
                        const [hours, minutes] = taskTime.split(':');
                        const start = new Date(taskDate);
                        start.setHours(parseInt(hours), parseInt(minutes));
                        const end = new Date(start);
                        end.setHours(start.getHours() + 1); // Default 1 hour duration
                        
                        startDateTime = { dateTime: start.toISOString() };
                        endDateTime = { dateTime: end.toISOString() };
                    } else {
                        // All day event
                        const dateStr = formatDateKey(taskDate);
                        startDateTime = { date: dateStr };
                        endDateTime = { date: dateStr };
                    }

                    const event = {
                        summary: taskText,
                        start: startDateTime,
                        end: endDateTime
                    };

                    const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${gCalToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(event)
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || "Failed to create event");
                    }

                    const data = await response.json();
                    return data.id; // Return Google Event ID
                } catch (error) {
                    console.error("Failed to add to Google:", error);
                    alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á Google Calendar ‡πÑ‡∏î‡πâ: ${error.message}`);
                }
                return null;
            };

            const deleteFromGoogle = async (googleEventId) => {
                if (!gCalToken || !googleEventId) return;
                try {
                    await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events/${googleEventId}`, {
                        method: 'DELETE',
                        headers: { Authorization: `Bearer ${gCalToken}` }
                    });
                } catch (error) {
                    console.error("Failed to delete from Google:", error);
                }
            };

            // Zoom Handlers
            const handleZoomIn = () => setZoom(prev => Math.min(prev + 0.1, 3.0));
            const handleZoomOut = () => setZoom(prev => Math.max(prev - 0.1, 0.4));
            const handleZoomReset = () => setZoom(1.0);

            // Export Handlers
            const handleSaveImage = async () => {
                if (!exportRef.current) return;
                try {
                    const canvas = await window.html2canvas(exportRef.current, { scale: 2 });
                    const link = document.createElement('a');
                    link.download = `OmniPlan_Note_${selectedDateKey}_p${notebookPage}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (error) {
                    console.error("Image Export Error:", error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
                }
            };

            const handleSavePDF = async () => {
                if (!exportRef.current) return;
                try {
                    const canvas = await window.html2canvas(exportRef.current, { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');
                    
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`OmniPlan_Note_${selectedDateKey}_p${notebookPage}.pdf`);
                } catch (error) {
                    console.error("PDF Export Error:", error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF");
                }
            };

            // Touch/Pinch Zoom Handlers
            const onTouchStart = (e) => {
                if (e.touches.length === 2) {
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    setTouchDist(dist);
                }
            };

            const onTouchMove = (e) => {
                if (e.touches.length === 2 && touchDist) {
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const delta = dist / touchDist;
                    // Apply a smoother zoom factor
                    setZoom(z => Math.min(Math.max(z * (1 + (delta - 1) * 0.5), 0.4), 3.0));
                    setTouchDist(dist);
                }
            };

            const onTouchEnd = () => {
                setTouchDist(null);
            };

            // Open Picker Handler
            const openColorPicker = (type) => {
                setPickerType(type);
                setPickerOpen(true);
            };

            // Handle Color Selection from Modal
            const handleColorSelect = (color) => {
                if (pickerType === 'bg') {
                    setNotebookColor(color);
                    // Update palette if index is active
                    if (activePaletteIndex !== null) {
                        const newPalette = [...notebookPalette];
                        newPalette[activePaletteIndex] = color;
                        setNotebookPalette(newPalette);
                    }
                } else if (pickerType === 'font') {
                    setNotebookFontColor(color);
                    if (activeFontPaletteIndex !== null) {
                        const newPalette = [...notebookFontPalette];
                        newPalette[activeFontPaletteIndex] = color;
                        setNotebookFontPalette(newPalette);
                    }
                } else if (pickerType === 'pen') {
                    setPenColor(color);
                    if (activePenPaletteIndex !== null) {
                        const newPalette = [...penPalette];
                        newPalette[activePenPaletteIndex] = color;
                        setPenPalette(newPalette);
                    }
                }
                setPickerOpen(false);
            };

            // RPG Logic
            const gainXP = (amount) => {
                let newXp = player.xp + amount;
                let newLevel = player.level;
                let newMaxXp = player.maxXp;
                let newHp = player.hp;

                if (newXp >= player.maxXp) {
                newLevel += 1;
                newXp = newXp - player.maxXp;
                newMaxXp = Math.floor(newMaxXp * 1.5);
                newHp = player.maxHp; 
                alert(`üéâ ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏õ! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πÄ‡∏ß‡∏• ${newLevel} ‡πÅ‡∏•‡πâ‡∏ß!`);
                }

                setPlayer({ ...player, xp: newXp, level: newLevel, maxXp: newMaxXp, hp: newHp });
            };

            const takeDamage = (amount) => {
                let newHp = Math.max(0, player.hp - amount);
                if (newHp === 0) {
                alert("üíÄ ‡∏à‡∏ö‡πÄ‡∏Å‡∏°... ‡∏•‡πâ‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ô‡πà‡∏≤ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ñ‡∏≠‡∏∞!");
                newHp = 10;
                }
                setPlayer({ ...player, hp: newHp });
            };

            // Task Handlers
            const addTask = async (text, time = null, category = 'normal', syncToGoogle = false) => { 
                if (!text.trim()) return;
                
                let googleEventId = null;
                
                // Add to Google Calendar if requested
                if (syncToGoogle && gCalToken) {
                    googleEventId = await addToGoogle(text, time === 'no-time' ? null : time, selectedDate);
                }

                const newTask = { 
                    id: Date.now(), 
                    text, 
                    completed: false, 
                    category, 
                    time,
                    googleEventId // Save ID to link for later deletion
                };

                const current = tasks[selectedDateKey] || [];
                setTasks({ ...tasks, [selectedDateKey]: [...current, newTask] });

                if (time && time !== 'no-time') {
                    const currentBlocks = timeBlocks[selectedDateKey] || {};
                    const existingNote = currentBlocks[time] || '';
                    const newNote = existingNote ? `${existingNote}, ${text}` : text;
                    setTimeBlocks({ ...timeBlocks, [selectedDateKey]: { ...currentBlocks, [time]: newNote } });
                }
            };

            const toggleTask = (id) => {
                const current = tasks[selectedDateKey] || [];
                const task = current.find(t => t.id === id);
                const updated = current.map(t => t.id === id ? { ...t, completed: !t.completed } : t);
                
                if (!task.completed) gainXP(10); 
                else setPlayer(p => ({ ...p, xp: Math.max(0, p.xp - 10) }));
                
                setTasks({ ...tasks, [selectedDateKey]: updated });
            };

            const deleteTask = (id) => {
                const current = tasks[selectedDateKey] || [];
                const taskToDelete = current.find(t => t.id === id);
                
                // If it's a Google linked event, delete from Google too
                if (taskToDelete && taskToDelete.googleEventId) {
                    if (confirm("‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ô‡∏µ‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Calendar ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏≤‡∏Å Google ‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                        deleteFromGoogle(taskToDelete.googleEventId);
                    }
                }

                setTasks({ ...tasks, [selectedDateKey]: current.filter(t => t.id !== id) });
            };

            const updateTimeBlock = (hour, value) => {
                const currentBlocks = timeBlocks[selectedDateKey] || {};
                setTimeBlocks({ ...timeBlocks, [selectedDateKey]: { ...currentBlocks, [hour]: value } });
            };

            // Timer Logic
            useEffect(() => {
                if (isTimerRunning && timer > 0) {
                timerRef.current = setTimeout(() => setTimer(t => t - 1), 1000);
                } else if (timer === 0 && isTimerRunning) {
                setIsTimerRunning(false);
                gainXP(50);
                alert("üßò ‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! +50 XP");
                }
                return () => clearTimeout(timerRef.current);
            }, [isTimerRunning, timer]);

            // --- COMPONENTS ---
            const TaskInputBar = ({ onAdd, placeholder, compact = false, category = 'normal' }) => {
                const [text, setText] = useState('');
                const [time, setTime] = useState('no-time');
                const [syncGoogle, setSyncGoogle] = useState(false); // Checkbox state

                const handleAdd = () => {
                    if(!text.trim()) return;
                    onAdd(text, time === 'no-time' ? null : time, category, syncGoogle);
                    setText('');
                    setTime('no-time');
                    setSyncGoogle(false);
                };

                return (
                <div className={`flex gap-2 mb-4 ${compact ? 'flex-col' : ''}`}>
                    <div className={`flex-1 flex gap-2 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-2 transition-all focus-within:ring-2 focus-within:ring-indigo-500 items-center`}>
                        <input type="text" placeholder={placeholder} value={text} onChange={(e) => setText(e.target.value)} className="flex-1 bg-transparent outline-none px-2 text-sm w-full" onKeyDown={(e) => e.key === 'Enter' && handleAdd()} />
                        <div className="flex items-center border-l pl-2 border-gray-300 dark:border-gray-600 flex-shrink-0 gap-2">
                            {gCalToken && (
                                <button 
                                    onClick={() => setSyncGoogle(!syncGoogle)} 
                                    className={`p-1 rounded-full transition-colors ${syncGoogle ? 'bg-sky-100 text-sky-600' : 'text-gray-400 hover:text-gray-600'}`}
                                    title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á Google Calendar"
                                >
                                    <Cloud size={16} />
                                </button>
                            )}
                            <Clock size={16} className="text-gray-400"/>
                            <select value={time} onChange={(e) => setTime(e.target.value)} className="bg-transparent text-xs font-medium text-gray-500 outline-none cursor-pointer max-w-[80px]">
                                <option value="no-time">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
                                {HOURS.map(h => (<option key={h} value={h}>{h}</option>))}
                            </select>
                        </div>
                    </div>
                    <button onClick={handleAdd} className={`bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 flex items-center justify-center ${compact ? 'w-full py-2' : ''}`}><Plus size={compact ? 18 : 24}/></button>
                </div>
                );
            };

            const DrawingPad = ({ className, storageKey, penColor, penSize }) => {
                const canvasRef = useRef(null);
                const [isDrawing, setIsDrawing] = useState(false);
                const contextRef = useRef(null);

                useEffect(() => {
                const canvas = canvasRef.current;
                // Use clientWidth/Height of the parent (A4 container) to determine resolution
                // This ensures correct resolution regardless of zoom scale applied to a wrapper
                const width = canvas.parentElement.clientWidth;
                const height = canvas.parentElement.clientHeight;
                
                canvas.width = width * 2; // Retina scale
                canvas.height = height * 2;
                canvas.style.width = `${width}px`;
                canvas.style.height = `${height}px`;
                
                const context = canvas.getContext("2d");
                context.scale(2, 2);
                context.lineCap = "round";
                context.lineJoin = "round";
                contextRef.current = context;
                if (drawings[storageKey]) {
                    const image = new Image();
                    image.src = drawings[storageKey];
                    image.onload = () => context.drawImage(image, 0, 0, width, height);
                }
                }, [storageKey]); 

                useEffect(() => {
                if (contextRef.current) {
                    contextRef.current.strokeStyle = penColor;
                    contextRef.current.lineWidth = penSize;
                }
                }, [penColor, penSize]);

                const startDrawing = ({ nativeEvent }) => {
                const { offsetX, offsetY } = nativeEvent;
                contextRef.current.beginPath();
                contextRef.current.moveTo(offsetX, offsetY);
                setIsDrawing(true);
                };

                const finishDrawing = () => {
                contextRef.current.closePath();
                setIsDrawing(false);
                saveDrawing();
                };

                const draw = ({ nativeEvent }) => {
                if (!isDrawing) return;
                const { offsetX, offsetY } = nativeEvent;
                contextRef.current.lineTo(offsetX, offsetY);
                contextRef.current.stroke();
                };

                const saveDrawing = () => {
                const canvas = canvasRef.current;
                const dataUrl = canvas.toDataURL();
                setDrawings({ ...drawings, [storageKey]: dataUrl });
                };

                const clearCanvas = () => {
                const canvas = canvasRef.current;
                const context = canvas.getContext("2d");
                context.clearRect(0, 0, canvas.width, canvas.height);
                setDrawings({ ...drawings, [storageKey]: null });
                };

                return (
                <div className={`relative w-full h-full overflow-hidden touch-none`}>
                    <canvas onMouseDown={startDrawing} onMouseUp={finishDrawing} onMouseMove={draw} onTouchStart={(e) => { const touch = e.touches[0]; const bcr = e.target.getBoundingClientRect(); startDrawing({ nativeEvent: { offsetX: touch.clientX - bcr.left, offsetY: touch.clientY - bcr.top } }); }} onTouchMove={(e) => { const touch = e.touches[0]; const bcr = e.target.getBoundingClientRect(); draw({ nativeEvent: { offsetX: touch.clientX - bcr.left, offsetY: touch.clientY - bcr.top } }); }} onTouchEnd={finishDrawing} ref={canvasRef} className="w-full h-full cursor-crosshair" />
                    <button onClick={clearCanvas} className="absolute top-2 right-2 p-2 bg-rose-500 text-white rounded-lg shadow-md hover:bg-rose-600 z-10"><Trash2 size={16}/></button>
                    <div className="absolute bottom-2 left-2 text-xs text-gray-400 pointer-events-none">‡∏ß‡∏≤‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</div>
                </div>
                );
            };

            const EisenhowerMatrix = () => {
                const categories = [
                { id: 'q1', title: 'üî• ‡∏ó‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Do)', desc: '‡∏î‡πà‡∏ß‡∏ô & ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', color: 'bg-rose-100 dark:bg-rose-900/30 border-rose-200 text-rose-700 dark:text-rose-300' },
                { id: 'q2', title: 'üìÖ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô (Schedule)', desc: '‡πÑ‡∏°‡πà‡∏î‡πà‡∏ß‡∏ô ‡πÅ‡∏ï‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', color: 'bg-blue-100 dark:bg-blue-900/30 border-blue-200 text-blue-700 dark:text-blue-300' },
                { id: 'q3', title: 'üó£Ô∏è ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Delegate)', desc: '‡∏î‡πà‡∏ß‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', color: 'bg-amber-100 dark:bg-amber-900/30 border-amber-200 text-amber-700 dark:text-amber-300' },
                { id: 'q4', title: 'üóëÔ∏è ‡∏•‡∏î/‡∏ó‡∏¥‡πâ‡∏á (Delete)', desc: '‡πÑ‡∏°‡πà‡∏î‡πà‡∏ß‡∏ô & ‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç', color: 'bg-gray-100 dark:bg-gray-800 border-gray-200 text-gray-500' },
                ];

                const [qInputs, setQInputs] = useState({ q1: '', q2: '', q3: '', q4: '' });
                const [qTimes, setQTimes] = useState({ q1: 'no-time', q2: 'no-time', q3: 'no-time', q4: 'no-time' });

                const addMatrixTaskLocal = (cat) => {
                addTask(qInputs[cat], qTimes[cat] === 'no-time' ? null : qTimes[cat], cat);
                setQInputs({ ...qInputs, [cat]: '' });
                setQTimes({ ...qTimes, [cat]: 'no-time' });
                };

                return (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 h-full overflow-y-auto pb-20">
                    {categories.map(cat => (
                    <div key={cat.id} className={`p-4 rounded-2xl border ${cat.color} min-h-[200px] flex flex-col`}>
                        <h3 className="font-bold text-sm mb-1">{cat.title}</h3>
                        <p className="text-xs opacity-70 mb-3">{cat.desc}</p>
                        
                        <div className="flex-1 space-y-2 mb-3">
                        {tasks[selectedDateKey]?.filter(t => t.category === cat.id).map(t => (
                            <div key={t.id} className="flex items-center gap-2 bg-white dark:bg-gray-900/50 p-2 rounded-lg shadow-sm">
                            <button onClick={() => toggleTask(t.id)}>{t.completed ? <CheckCircle size={16} className="text-emerald-500"/> : <Circle size={16}/>}</button>
                            <span className={`text-xs flex-1 ${t.completed ? 'line-through opacity-50' : ''}`}>
                                {t.time && <span className="text-[10px] bg-indigo-100 text-indigo-700 dark:bg-indigo-900 px-1 rounded mr-1">{t.time}</span>}
                                {t.text}
                            </span>
                            <button onClick={() => deleteTask(t.id)} className="text-gray-400 hover:text-red-500"><Trash2 size={12}/></button>
                            </div>
                        ))}
                        </div>

                        <div className="flex gap-1 items-center bg-white dark:bg-gray-900/50 p-1 rounded-lg border border-transparent focus-within:border-indigo-400">
                        <input className="flex-1 text-xs p-1 outline-none bg-transparent" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô..." value={qInputs[cat.id]} onChange={e => setQInputs({ ...qInputs, [cat.id]: e.target.value })} onKeyDown={e => e.key === 'Enter' && addMatrixTaskLocal(cat.id)} />
                        <select value={qTimes[cat.id]} onChange={(e) => setQTimes({ ...qTimes, [cat.id]: e.target.value })} className="bg-transparent text-[10px] text-gray-500 outline-none cursor-pointer max-w-[50px]">
                            <option value="no-time">--:--</option>
                            {HOURS.map(h => (<option key={h} value={h}>{h}</option>))}
                        </select>
                        <button onClick={() => addMatrixTaskLocal(cat.id)} className="p-1.5 bg-gray-100 dark:bg-gray-700 rounded hover:bg-gray-200"><Plus size={14}/></button>
                        </div>
                    </div>
                    ))}
                </div>
                );
            };

            return (
                <div className={`min-h-screen font-sans transition-colors duration-300 flex flex-col ${isDarkMode ? 'bg-gray-900 text-gray-100' : 'bg-slate-50 text-slate-800'}`}>
                
                <ColorPickerModal 
                    isOpen={pickerOpen} 
                    onClose={() => setPickerOpen(false)} 
                    onSelect={handleColorSelect} 
                    title={pickerType === 'bg' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á' : pickerType === 'font' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤'}
                />

                {/* Add App Portal Modal */}
                {isPortalModalOpen && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                        <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-2xl flex flex-col gap-4 max-w-sm w-full mx-4">
                            <div className="flex justify-between items-center border-b pb-2 dark:border-gray-700">
                                <h3 className="text-lg font-bold text-gray-800 dark:text-gray-200">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏û‡πÉ‡∏´‡∏°‡πà</h3>
                                <button onClick={() => setIsPortalModalOpen(false)} className="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><X size={20}/></button>
                            </div>
                            <div className="space-y-3">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏û</label>
                                    <input type="text" className="w-full p-2 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 outline-none text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô Google, Facebook" value={newApp.name} onChange={e => setNewApp({...newApp, name: e.target.value})} />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 mb-1 block">URL (‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå)</label>
                                    <input type="text" className="w-full p-2 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 outline-none text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô google.com" value={newApp.url} onChange={e => setNewApp({...newApp, url: e.target.value})} />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 mb-1 block">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (Emoji/URL)</label>
                                        <input type="text" className="w-full p-2 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 outline-none text-sm" placeholder="Emoji üöÄ ‡∏´‡∏£‡∏∑‡∏≠ Link ‡∏£‡∏π‡∏õ" value={newApp.icon} onChange={e => setNewApp({...newApp, icon: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 mb-1 block">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                        <input type="text" list="categories" className="w-full p-2 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 outline-none text-sm" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà..." value={newApp.category} onChange={e => setNewApp({...newApp, category: e.target.value})} />
                                        <datalist id="categories">
                                            {PORTAL_CATEGORIES.filter(c => c !== '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î').map(c => <option key={c} value={c}/>)}
                                        </datalist>
                                    </div>
                                </div>
                            </div>
                            <button onClick={handleAddApp} className="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 font-bold shadow-lg shadow-indigo-200 mt-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏≠‡∏û</button>
                        </div>
                    </div>
                )}

                {isZenMode && (
                    <div className="fixed inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center text-white animate-in fade-in duration-500">
                        <div className="text-8xl md:text-9xl font-thin font-mono mb-12 tracking-tighter">
                            {Math.floor(timer / 60).toString().padStart(2, '0')}:{ (timer % 60).toString().padStart(2, '0') }
                        </div>
                        <div className="flex items-center justify-center gap-8">
                            <button onClick={() => setIsTimerRunning(!isTimerRunning)} className={`w-20 h-20 rounded-full flex items-center justify-center border-2 transition-all ${isTimerRunning ? 'border-rose-400 text-rose-400' : 'border-emerald-400 text-emerald-400'}`}>
                                {isTimerRunning ? <Pause size={32}/> : <Play size={32} className="ml-2"/>}
                            </button>
                            <button onClick={() => setIsZenMode(false)} className="w-16 h-16 rounded-full border-2 border-gray-600 text-gray-400 flex items-center justify-center hover:border-gray-400 hover:text-white transition-all"><X size={24}/></button>
                        </div>
                    </div>
                )}

                <div className={`${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-b px-4 py-3 sticky top-0 z-30 shadow-sm`}>
                    <div className="max-w-7xl mx-auto flex justify-between items-center">
                    <div className="flex items-center gap-4 flex-1">
                        <div className="relative w-12 h-12">
                        <div className="w-full h-full rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold text-lg shadow-lg">{player.level}</div>
                        </div>
                        <div className="flex-1 max-w-xs hidden sm:block">
                        <div className="flex justify-between text-xs font-bold mb-1"><span>{player.name}</span><span className="text-indigo-500">{player.xp}/{player.maxXp} XP</span></div>
                        <div className="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-500" style={{ width: `${(player.xp / player.maxXp) * 100}%` }}></div></div>
                        </div>
                    </div>
                    <div className="flex items-center gap-3">
                        {user ? (
                            <>
                                {gCalToken ? (
                                    <button onClick={syncFromGoogle} disabled={isSyncing} className={`flex items-center gap-2 px-3 py-1.5 bg-sky-100 text-sky-700 dark:bg-sky-900/30 dark:text-sky-400 rounded-full text-xs font-bold transition-transform ${isSyncing ? 'animate-pulse' : 'hover:scale-105'}`}>
                                        <RefreshCw size={14} className={isSyncing ? "animate-spin" : ""} />
                                        <span className="hidden sm:inline">{isSyncing ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå..." : "‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô"}</span>
                                    </button>
                                ) : (
                                    <button onClick={handleLogin} className="flex items-center gap-2 px-3 py-1.5 bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 rounded-full text-xs font-bold hover:bg-gray-200" title="‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Calendar ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå">
                                        <LinkIcon size={14} /> <span className="hidden sm:inline">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</span>
                                    </button>
                                )}
                                <button onClick={() => setIsZenMode(true)} className="flex items-center gap-2 px-3 py-1.5 bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400 rounded-full text-xs font-bold hover:scale-105 transition-transform"><Zap size={14}/> Zen Mode</button>
                                <button onClick={handleLogout} className="flex items-center gap-2 px-3 py-1.5 bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 rounded-full text-xs font-bold"><img src={user.photoURL} alt="User" className="w-4 h-4 rounded-full"/><span className="hidden sm:inline">Logout</span><LogOut size={14}/></button>
                            </>
                        ) : (<button onClick={handleLogin} className="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white rounded-full text-xs font-bold shadow-lg shadow-indigo-200"><LogIn size={14}/><span>Login</span></button>)}
                        <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">{isDarkMode ? <Sun size={20}/> : <Moon size={20}/>}</button>
                    </div>
                    </div>
                </div>

                <main className="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                    {/* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô nav ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Scroll ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */}
                    <nav className="lg:col-span-1 flex lg:flex-col overflow-x-auto custom-scrollbar lg:overflow-visible justify-start lg:justify-start gap-4 lg:gap-6 bg-white dark:bg-gray-800 lg:bg-transparent lg:dark:bg-transparent p-3 fixed bottom-0 left-0 right-0 lg:static z-20 border-t lg:border-none shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] lg:shadow-none">
                    {[
                        { id: 'calendar', icon: <CalendarIcon/>, label: '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô' },
                        { id: 'planner', icon: <LayoutList/>, label: '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô' },
                        { id: 'matrix', icon: <Grid/>, label: '‡πÅ‡∏°‡∏ó‡∏£‡∏¥‡∏Å‡∏ã‡πå' },
                        { id: 'notebook', icon: <Book/>, label: '‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' },
                        { id: 'portal', icon: <Globe/>, label: '‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏≠‡∏û' },
                        { id: 'rpg', icon: <User/>, label: '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå' },
                    ].map(item => (
                        <button key={item.id} onClick={() => setView(item.id)} className={`flex-shrink-0 min-w-[60px] flex flex-col items-center gap-1 p-2 rounded-xl transition-all ${view === item.id ? 'text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 dark:text-indigo-400 scale-105 font-bold' : 'text-gray-400 hover:text-gray-600'}`}>
                            {item.icon}
                            <span className="text-[10px] whitespace-nowrap">{item.label}</span>
                        </button>
                    ))}
                    </nav>

                    <section className="lg:col-span-11 pb-24 lg:pb-0">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-4 bg-white dark:bg-gray-800 p-2 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl"><ChevronLeft size={20}/></button>
                            <div className="text-center w-32"><div className="font-bold text-lg">{thaiMonths[currentDate.getMonth()]}</div><div className="text-xs text-gray-500">{currentDate.getFullYear() + 543}</div></div>
                            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-xl"><ChevronRight size={20}/></button>
                        </div>
                        {view !== 'calendar' && (
                        <div className="hidden md:flex gap-1 overflow-x-auto max-w-md pb-1 custom-scrollbar">
                            {Array.from({length: new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate()}, (_, i) => i + 1).map(day => {
                                const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                                const isSel = formatDateKey(d) === selectedDateKey;
                                return (<button key={day} onClick={() => setSelectedDate(d)} className={`flex-shrink-0 w-10 h-12 rounded-lg flex flex-col items-center justify-center text-xs font-bold border transition-all ${isSel ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg shadow-indigo-200' : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 text-gray-500 hover:border-indigo-300'}`}><span>{day}</span><span className="text-[8px] opacity-70">{['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'][d.getDay()]}</span></button>)
                            })}
                        </div>
                        )}
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {view === 'calendar' && (
                        <>
                            <div className="lg:col-span-2">
                            <div className="w-full bg-white dark:bg-gray-800 rounded-3xl p-6 shadow-sm border border-gray-100 dark:border-gray-700 h-full">
                                <div className="grid grid-cols-7 gap-1 mb-2 text-center text-sm font-bold text-gray-400 uppercase tracking-wider">{['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'].map(d => <div key={d} className="py-2">{d}</div>)}</div>
                                <div className="grid grid-cols-7 gap-1">
                                    {Array.from({length: new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay()}).map((_, i) => (<div key={`empty-${i}`} className="h-24"></div>))}
                                    {Array.from({length: new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate()}, (_, i) => i + 1).map(day => {
                                    const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                                    const dKey = formatDateKey(d);
                                    const isSel = dKey === selectedDateKey;
                                    const isToday = dKey === formatDateKey(new Date());
                                    const dayTasks = tasks[dKey] || [];
                                    return (
                                        <button key={day} onClick={() => setSelectedDate(d)} className={`h-24 rounded-2xl border p-1.5 flex flex-col justify-between transition-all hover:scale-[1.02] relative ${isSel ? 'border-indigo-500 ring-2 ring-indigo-200 dark:ring-indigo-900 bg-indigo-50 dark:bg-indigo-900/20' : 'border-gray-100 dark:border-gray-700 hover:border-indigo-300'} ${isToday ? 'bg-amber-50 dark:bg-amber-900/10' : ''}`}>
                                        <div className="flex justify-between items-start w-full"><span className={`text-sm font-bold ${isSel ? 'text-indigo-600' : 'text-gray-700 dark:text-gray-300'}`}>{day}</span>{isToday && <span className="text-[10px] bg-amber-200 text-amber-800 px-1.5 rounded-full font-bold">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>}</div>
                                        <div className="flex flex-wrap gap-1 content-end justify-end mt-1 w-full">{dayTasks.map((t, idx) => (<div key={idx} className={`w-2 h-2 rounded-full ${getTaskColor(t)} shadow-sm`} title={t.text}/>))}</div>
                                        </button>
                                    )
                                    })}
                                </div>
                            </div>
                            </div>
                            <div className="lg:col-span-1">
                            <div className="bg-white dark:bg-gray-800 rounded-3xl p-6 shadow-sm border border-gray-100 dark:border-gray-700 h-full flex flex-col">
                                <h3 className="font-bold text-lg mb-4 text-gray-800 dark:text-gray-200 flex items-center gap-2"><span className="text-indigo-500">{selectedDate.getDate()} {thaiMonths[selectedDate.getMonth()]}</span></h3>
                                <TaskInputBar onAdd={addTask} placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à..." compact={true} />
                                <div className="flex-1 overflow-y-auto custom-scrollbar pr-1 space-y-2">
                                    {!tasks[selectedDateKey]?.length && (<div className="text-center py-10 opacity-40 text-sm"><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p></div>)}
                                    {tasks[selectedDateKey]?.map(task => (
                                        <div key={task.id} className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/20">
                                        <button onClick={() => toggleTask(task.id)} className={task.completed ? 'text-emerald-500' : 'text-gray-400 hover:text-indigo-500'}>{task.completed ? <CheckCircle size={18}/> : <Circle size={18}/>}</button>
                                        <div className="flex-1 overflow-hidden">
                                            <p className={`text-sm truncate ${task.completed ? 'line-through text-gray-400' : ''}`}>
                                                {task.time && <span className="text-[10px] bg-indigo-100 text-indigo-700 dark:bg-indigo-900 px-1 rounded mr-1">{task.time}</span>}
                                                {task.text}
                                            </p>
                                            {task.category === 'google' && <span className="text-[10px] text-sky-500 flex items-center gap-0.5"><Cloud size={10}/> Google Calendar</span>}
                                        </div>
                                        <button onClick={() => deleteTask(task.id)} className="text-gray-300 hover:text-rose-500"><Trash2 size={14}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            </div>
                        </>
                        )}

                        {view === 'planner' && (
                        <>
                            <div className="lg:col-span-2 space-y-4">
                            <div className="flex gap-2 border-b dark:border-gray-700 pb-2">
                                {[{ id: 'tasks', label: '‡∏á‡∏≤‡∏ô', icon: <CheckCircle size={16}/> }, { id: 'timeline', label: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤', icon: <Clock size={16}/> }].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-bold transition-all ${activeTab === tab.id ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300' : 'text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800'}`}>{tab.icon} {tab.label}</button>
                                ))}
                            </div>
                            <div className="bg-white dark:bg-gray-800 rounded-3xl p-6 shadow-sm min-h-[500px] border border-gray-100 dark:border-gray-700">
                                {activeTab === 'tasks' && (
                                    <div className="animate-in fade-in zoom-in-95 duration-300">
                                    <TaskInputBar onAdd={addTask} placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà..." />
                                    <div className="space-y-3">
                                        {!tasks[selectedDateKey]?.length && (<div className="text-center py-20 opacity-40"><Sword size={48} className="mx-auto mb-2"/><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏£‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà!</p></div>)}
                                        {tasks[selectedDateKey]?.map(task => (
                                        <div key={task.id} className={`group flex items-center gap-4 p-4 rounded-2xl border transition-all hover:scale-[1.01] ${task.completed ? 'bg-gray-50 dark:bg-gray-900/30 border-gray-100 opacity-60' : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 shadow-sm'}`}>
                                            <button onClick={() => toggleTask(task.id)} className={`transition-colors ${task.completed ? 'text-emerald-500' : 'text-gray-300 hover:text-indigo-500'}`}>{task.completed ? <CheckCircle size={24} className="fill-emerald-100 dark:fill-emerald-900"/> : <Circle size={24}/>}</button>
                                            <div className="flex-1">
                                            <p className={`font-medium ${task.completed ? 'line-through text-gray-400' : ''}`}>{task.time && <span className="text-xs bg-indigo-100 text-indigo-700 dark:bg-indigo-900 px-1.5 py-0.5 rounded mr-2 font-bold">{task.time}</span>}{task.text}</p>
                                            <div className="flex gap-2">
                                                {task.category !== 'normal' && <span className="text-[10px] uppercase font-bold tracking-wider text-indigo-400">{task.category}</span>}
                                                {task.category === 'google' && <span className="text-[10px] bg-sky-100 text-sky-600 px-1.5 rounded-full font-bold flex items-center gap-1"><Cloud size={10}/> Google</span>}
                                            </div>
                                            </div>
                                            <div className="text-xs font-bold text-amber-500 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">+10 XP <Trash2 size={14} className="text-gray-300 hover:text-rose-500 cursor-pointer ml-2" onClick={() => deleteTask(task.id)}/></div>
                                        </div>
                                        ))}
                                    </div>
                                    </div>
                                )}
                                {activeTab === 'timeline' && (
                                    <div className="animate-in fade-in zoom-in-95 duration-300 h-[500px] overflow-y-auto custom-scrollbar pr-2">
                                    <h3 className="font-bold text-gray-400 mb-4 text-xs uppercase tracking-wider">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</h3>
                                    <div className="space-y-1">
                                        {Array.from({length: 16}, (_, i) => i + 6).map(hour => { const time = `${hour.toString().padStart(2, '0')}:00`; return (<div key={hour} className="flex gap-3 group"><div className="w-12 text-xs font-medium text-gray-400 pt-3 text-right">{time}</div><div className="flex-1 relative"><input type="text" placeholder="‡∏ß‡πà‡∏≤‡∏á" value={timeBlocks[selectedDateKey]?.[time] || ''} onChange={(e) => updateTimeBlock(time, e.target.value)} className={`w-full p-2.5 rounded-lg border text-sm outline-none transition-all ${timeBlocks[selectedDateKey]?.[time] ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 text-indigo-700' : 'bg-transparent border-gray-100 dark:border-gray-700 hover:border-gray-300'}`}/></div></div>) })}
                                    </div>
                                    </div>
                                )}
                            </div>
                            </div>
                            <div className="lg:col-span-1 space-y-6">
                            <div className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-8 opacity-10"><Sword size={120}/></div>
                                <h3 className="text-xs font-bold opacity-70 uppercase tracking-widest mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                                <div className="text-2xl font-bold mb-4">{player.name}</div>
                                <div className="grid grid-cols-2 gap-4 mb-4"><div className="bg-white/10 p-3 rounded-2xl backdrop-blur-sm"><div className="text-xs opacity-70">‡πÄ‡∏•‡πÄ‡∏ß‡∏•</div><div className="text-xl font-bold">{player.level}</div></div><div className="bg-white/10 p-3 rounded-2xl backdrop-blur-sm"><div className="text-xs opacity-70">‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</div><div className="text-xl font-bold">üî• {player.streak} ‡∏ß‡∏±‡∏ô</div></div></div>
                                <div className="space-y-2"><div className="flex justify-between text-xs font-medium"><span>‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</span><span>{player.hp}/{player.maxHp}</span></div><div className="w-full h-1.5 bg-black/20 rounded-full overflow-hidden"><div className="h-full bg-rose-400" style={{ width: `${(player.hp / player.maxHp) * 100}%` }}></div></div><p className="text-[10px] opacity-60 text-center pt-2">‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö XP ‡∏´‡∏≤‡∏Å‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏∞‡πÄ‡∏™‡∏µ‡∏¢ HP</p></div>
                            </div>
                            <div className="bg-white dark:bg-gray-800 rounded-3xl p-6 border border-gray-100 dark:border-gray-700">
                                <h3 className="font-bold mb-4 flex items-center gap-2"><Target size={18} className="text-rose-500"/> ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center text-sm"><span className="text-gray-500">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</span><span className="font-bold">{tasks[selectedDateKey]?.filter(t=>t.completed).length || 0}/{tasks[selectedDateKey]?.length || 0}</span></div>
                                    <div className="flex justify-between items-center text-sm"><span className="text-gray-500">XP ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span><span className="font-bold text-amber-500">+{tasks[selectedDateKey]?.filter(t=>t.completed).length * 10} XP</span></div>
                                </div>
                            </div>
                            </div>
                        </>
                        )}

                        {view === 'matrix' && (
                        <div className="lg:col-span-3 h-full">
                            <div className="bg-white dark:bg-gray-800 rounded-3xl p-6 shadow-sm min-h-[600px] border border-gray-100 dark:border-gray-700">
                            <h2 className="text-2xl font-bold mb-2 flex items-center gap-2"><Layout className="text-indigo-500"/> Eisenhower Matrix</h2>
                            <p className="text-gray-500 mb-6 text-sm">‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á</p>
                            <EisenhowerMatrix />
                            </div>
                        </div>
                        )}
                        
                        {view === 'notebook' && (
                        <div className="lg:col-span-3 h-full">
                            <div className="bg-white dark:bg-gray-800 rounded-3xl p-6 shadow-sm min-h-[600px] border border-gray-100 dark:border-gray-700 flex flex-col h-[calc(100vh-140px)] md:h-[calc(100vh-120px)] overflow-hidden">
                                {/* Toolbar */}
                                <div className="flex flex-col sm:flex-row justify-between items-center mb-2 gap-2 flex-shrink-0">
                                    <div className="flex items-center gap-3 self-start sm:self-auto"><Book className="text-indigo-500" size={24}/><div><h2 className="text-xl font-bold">‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2></div></div>
                                    <div className="flex items-center gap-2">
                                        {/* Zoom & Export Controls */}
                                        <div className="flex items-center bg-gray-100 dark:bg-gray-700 rounded-lg p-1 mr-2 gap-1">
                                            <button onClick={handleSaveImage} className="p-1.5 hover:bg-white dark:hover:bg-gray-600 rounded text-gray-500" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"><ImageIcon size={16}/></button>
                                            <button onClick={handleSavePDF} className="p-1.5 hover:bg-white dark:hover:bg-gray-600 rounded text-gray-500" title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF"><FileDown size={16}/></button>
                                            <div className="w-px h-4 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                                            <button onClick={handleZoomOut} className="p-1.5 hover:bg-white dark:hover:bg-gray-600 rounded text-gray-500"><ZoomOut size={16}/></button>
                                            <span className="text-xs font-bold w-12 text-center select-none">{Math.round(zoom * 100)}%</span>
                                            <button onClick={handleZoomIn} className="p-1.5 hover:bg-white dark:hover:bg-gray-600 rounded text-gray-500"><ZoomIn size={16}/></button>
                                            <button onClick={handleZoomReset} className="p-1.5 hover:bg-white dark:hover:bg-gray-600 rounded text-gray-500 ml-1 border-l border-gray-200 dark:border-gray-600"><Maximize size={16}/></button>
                                        </div>

                                        <div className="flex items-center bg-gray-100 dark:bg-gray-700 rounded-full px-2 py-1"><button onClick={() => setNotebookPage(p => Math.max(1, p - 1))} className="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500"><ChevronLeft size={14}/></button><span className="text-xs font-bold mx-2 w-12 text-center select-none">‡∏´‡∏ô‡πâ‡∏≤ {notebookPage}</span><button onClick={() => setNotebookPage(p => p + 1)} className="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-500"><ChevronRight size={14}/></button></div>
                                    </div>
                                </div>
                                
                                {/* Tools */}
                                <div className="flex flex-wrap justify-end items-center gap-2 mb-2 flex-shrink-0">
                                    {notebookMode === 'text' && (
                                    <div className="flex items-center gap-2 bg-gray-50 dark:bg-gray-900/50 p-1.5 rounded-xl border border-gray-100 dark:border-gray-700">
                                        <div className="flex items-center gap-1 border-r pr-2 border-gray-200 dark:border-gray-600">
                                            {notebookPalette.slice(0, 4).map((c, idx) => (<button key={idx} onClick={() => { setNotebookColor(c); setActivePaletteIndex(idx); }} className={`w-5 h-5 rounded-full border border-gray-300 transition-transform ${activePaletteIndex === idx ? 'scale-125 ring-2 ring-indigo-500 z-10' : 'hover:scale-110'}`} style={{ backgroundColor: c }} />))}
                                            <button onClick={() => openColorPicker('bg')} className="w-5 h-5 rounded-full border border-gray-300 cursor-pointer overflow-hidden relative flex items-center justify-center shadow-sm hover:scale-110 transition-transform" style={{ background: 'conic-gradient(from 180deg, red, yellow, lime, aqua, blue, magenta, red)' }}><div className="absolute inset-0 rounded-full" style={{background: 'radial-gradient(circle, transparent 40%, white 100%)', opacity: 0.2}}></div></button>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button onClick={() => openColorPicker('font')} className="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600"><Type size={14} className="text-gray-500" style={{ color: notebookFontColor }}/></button>
                                            <div className="flex bg-gray-200 dark:bg-gray-700 rounded p-0.5">
                                            {FONT_SIZES.slice(1, 4).map((size) => (<button key={size.id} onClick={() => setNotebookFontSize(size.id)} className={`px-1.5 rounded text-[10px] font-bold transition-all ${notebookFontSize === size.id ? 'bg-white dark:bg-gray-600 shadow text-indigo-600' : 'text-gray-500 hover:text-gray-800'}`}>{size.label}</button>))}
                                            </div>
                                        </div>
                                    </div>
                                    )}
                                    {notebookMode === 'draw' && (
                                    <div className="flex items-center gap-2 bg-gray-50 dark:bg-gray-900/50 p-1.5 rounded-xl border border-gray-100 dark:border-gray-700">
                                        <div className="flex bg-gray-200 dark:bg-gray-700 rounded p-0.5 mr-2">
                                        {PEN_SIZES.map((size) => (<button key={size.id} onClick={() => setPenSize(size.id)} className={`px-1.5 rounded text-[10px] font-bold transition-all ${penSize === size.id ? 'bg-white dark:bg-gray-600 shadow text-indigo-600' : 'text-gray-500 hover:text-gray-800'}`}>{size.label}</button>))}
                                        </div>
                                        <div className="flex items-center gap-1">
                                            {penPalette.slice(0, 4).map((c, idx) => (<button key={idx} onClick={() => { setPenColor(c); setActivePenPaletteIndex(idx); }} className={`w-5 h-5 rounded-full border border-gray-300 transition-transform ${activePenPaletteIndex === idx ? 'scale-125 ring-2 ring-indigo-500 z-10' : 'hover:scale-110'}`} style={{ backgroundColor: c }} />))}
                                            <button onClick={() => openColorPicker('pen')} className="w-5 h-5 rounded-full border border-gray-300 cursor-pointer overflow-hidden relative flex items-center justify-center shadow-sm hover:scale-110 transition-transform" style={{ background: 'conic-gradient(from 180deg, red, yellow, lime, aqua, blue, magenta, red)' }}><PenTool size={12} className="text-white drop-shadow-md relative z-10"/></button>
                                        </div>
                                    </div>
                                    )}
                                    <div className="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1 self-end"><button onClick={() => setNotebookMode('text')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${notebookMode === 'text' ? 'bg-white dark:bg-gray-600 shadow-sm text-indigo-600 dark:text-indigo-400' : 'text-gray-500 hover:text-gray-700'}`}>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button><button onClick={() => setNotebookMode('draw')} className={`px-3 py-1.5 rounded-md text-xs font-bold transition-all ${notebookMode === 'draw' ? 'bg-white dark:bg-gray-600 shadow-sm text-indigo-600 dark:text-indigo-400' : 'text-gray-500 hover:text-gray-700'}`}>‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</button></div>
                                </div>
                                
                                {/* Scrollable Container with Zoom */}
                                <div 
                                    className="flex-1 overflow-auto bg-gray-200 dark:bg-gray-900/50 rounded-xl relative touch-none custom-scrollbar" 
                                    onTouchStart={onTouchStart}
                                    onTouchMove={onTouchMove}
                                    onTouchEnd={onTouchEnd}
                                    style={{ touchAction: 'none' }} // Prevent browser zoom interference
                                >
                                    <div className="min-w-full min-h-full flex items-start justify-center p-8 origin-top-left md:origin-top" style={{ transform: `scale(${zoom})`, transformOrigin: 'top center', transition: 'transform 0.1s ease-out' }}>
                                        {/* A4 Paper Container: 794px x 1123px is approx A4 at 96dpi. We use a responsive-ish A4 ratio but fixed base for zoom consistency */}
                                        <div 
                                            ref={exportRef}
                                            className="bg-white shadow-2xl transition-colors duration-300 relative overflow-hidden flex-shrink-0" 
                                            style={{ 
                                                width: '794px', 
                                                height: '1123px', 
                                                backgroundColor: notebookColor 
                                            }}
                                        >
                                            {notebookMode === 'text' ? (
                                                <div className="w-full h-full relative">
                                                    <div className="absolute inset-0 pointer-events-none shadow-[inset_0_0_40px_rgba(0,0,0,0.05)]"></div>
                                                    <textarea 
                                                        className={`w-full h-full bg-transparent p-12 resize-none outline-none leading-relaxed ${notebookFontSize}`} 
                                                        style={{ color: notebookFontColor }} 
                                                        placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ..." 
                                                        value={notes[currentNoteKey] || ''} 
                                                        onChange={(e) => setNotes({...notes, [currentNoteKey]: e.target.value})} 
                                                    />
                                                </div>
                                            ) : (
                                                <DrawingPad storageKey={currentNoteKey} penColor={penColor} penSize={penSize} />
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        )}

                        {view === 'portal' && (
                        <div className="lg:col-span-3 h-full">
                            <div className="bg-white dark:bg-gray-800 rounded-3xl p-6 shadow-sm min-h-[600px] border border-gray-100 dark:border-gray-700 flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex items-center gap-3"><Globe className="text-indigo-500" size={28}/> <h2 className="text-2xl font-bold">‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏≠‡∏û‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</h2></div>
                                    <button onClick={() => setIsPortalModalOpen(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 flex items-center gap-2 text-sm font-bold"><Plus size={18}/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏û</button>
                                </div>

                                {/* Category Tabs */}
                                <div className="flex gap-2 overflow-x-auto pb-4 mb-4 custom-scrollbar">
                                    {PORTAL_CATEGORIES.map(cat => (
                                        <button 
                                            key={cat} 
                                            onClick={() => setActivePortalTab(cat)}
                                            className={`px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap transition-all ${activePortalTab === cat ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200 scale-105' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-600'}`}
                                        >
                                            {cat}
                                        </button>
                                    ))}
                                </div>

                                {/* Content Area */}
                                <div className="flex-1 overflow-y-auto custom-scrollbar pr-2">
                                    {(() => {
                                        const filteredApps = activePortalTab === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' 
                                            ? portalApps 
                                            : portalApps.filter(app => app.category === activePortalTab);

                                        if (filteredApps.length === 0) {
                                            return (
                                                <div className="text-center py-20 opacity-40">
                                                    <Globe size={64} className="mx-auto mb-4 text-gray-300"/>
                                                    <p className="text-lg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏≠‡∏û‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "{activePortalTab}"</p>
                                                    <p className="text-sm">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏û" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏õ‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                                                </div>
                                            );
                                        }

                                        return (
                                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 pb-4">
                                                {filteredApps.map(app => (
                                                    <a 
                                                        key={app.id} 
                                                        href={app.url} 
                                                        target="_blank" 
                                                        rel="noopener noreferrer"
                                                        className="group relative flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900/50 hover:bg-white dark:hover:bg-gray-700 border border-gray-200 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-500 rounded-2xl p-4 transition-all hover:shadow-lg hover:-translate-y-1"
                                                    >
                                                        <div className="w-12 h-12 mb-3 rounded-full bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center text-2xl overflow-hidden">
                                                            {app.icon.startsWith('http') ? <img src={app.icon} alt={app.name} className="w-full h-full object-cover" /> : app.icon}
                                                        </div>
                                                        <span className="font-bold text-sm text-center line-clamp-1">{app.name}</span>
                                                        <span className="text-[10px] text-gray-400 mt-1">{app.category}</span>
                                                        <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={(e) => { e.preventDefault(); handleDeleteApp(app.id, e); }} className="p-1 bg-white dark:bg-gray-800 text-rose-500 rounded-full hover:bg-rose-50 shadow-sm"><Trash2 size={12}/></button>
                                                        </div>
                                                        <ExternalLink size={12} className="absolute bottom-2 right-2 text-gray-300 opacity-0 group-hover:opacity-100"/>
                                                    </a>
                                                ))}
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        </div>
                        )}

                        {view === 'rpg' && (
                        <div className="lg:col-span-3">
                            <div className="bg-white dark:bg-gray-800 rounded-3xl p-8 text-center shadow-sm border border-gray-100 dark:border-gray-700 min-h-[500px] flex flex-col items-center justify-center">
                                <div className="w-32 h-32 bg-gradient-to-tr from-indigo-500 to-pink-500 rounded-full flex items-center justify-center text-5xl font-bold text-white mb-6 shadow-xl ring-4 ring-indigo-100 dark:ring-indigo-900">{player.level}</div>
                                <h2 className="text-3xl font-bold mb-2">{player.name}</h2>
                                <p className="text-indigo-500 font-medium mb-8">‡∏Æ‡∏µ‡πÇ‡∏£‡πà‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ú‡∏•</p>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-2xl">
                                <div className="p-6 bg-gray-50 dark:bg-gray-900 rounded-2xl"><Sword className="mx-auto mb-3 text-indigo-500" size={32}/><div className="text-2xl font-bold">{player.xp}</div><div className="text-xs text-gray-500 uppercase tracking-widest">XP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
                                <div className="p-6 bg-gray-50 dark:bg-gray-900 rounded-2xl"><Heart className="mx-auto mb-3 text-rose-500" size={32}/><div className="text-2xl font-bold">{player.hp}</div><div className="text-xs text-gray-500 uppercase tracking-widest">‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div></div>
                                <div className="p-6 bg-gray-50 dark:bg-gray-900 rounded-2xl"><Shield className="mx-auto mb-3 text-emerald-500" size={32}/><div className="text-2xl font-bold">{player.level * 10}%</div><div className="text-xs text-gray-500 uppercase tracking-widest">‡∏ö‡∏±‡∏ü‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div></div>
                                </div>
                                <button onClick={() => { const newName = prompt("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Æ‡∏µ‡πÇ‡∏£‡πà‡πÉ‡∏´‡∏°‡πà:", player.name); if(newName) setPlayer({...player, name: newName}); }} className="mt-8 text-gray-400 hover:text-indigo-500 text-sm underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏Æ‡∏µ‡πÇ‡∏£‡πà</button>
                            </div>
                        </div>
                        )}
                    </div>
                    </section>
                </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<OmniPlan />);
    </script>
</body>
</html>
